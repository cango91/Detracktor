#!/bin/bash
# pre-push hook to validate version synchronization
# Install with: cp hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

set -e

# Check if we're pushing a tag
while read local_ref local_sha remote_ref remote_sha; do
    if [[ "$local_ref" =~ refs/tags/ ]]; then
        TAG_NAME=$(basename "$local_ref")
        
        echo "Validating version synchronization for tag: $TAG_NAME"
        
        # Extract version from tag (remove 'v' prefix)
        TAG_VERSION="${TAG_NAME#v}"
        
        # Check if version.properties exists
        if [ ! -f "version.properties" ]; then
            echo "Error: version.properties not found!"
            echo "Run: ./scripts/sync-version.sh $TAG_NAME"
            exit 1
        fi
        
        # Read current version from version.properties
        CURRENT_VERSION=$(grep "VERSION_NAME=" version.properties | cut -d'=' -f2)
        
        # Compare versions
        if [ "$TAG_VERSION" != "$CURRENT_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "  Tag version: $TAG_VERSION"
            echo "  version.properties: $CURRENT_VERSION"
            echo ""
            echo "To fix:"
            echo "1. Run: ./scripts/sync-version.sh $TAG_NAME"
            echo "2. Commit the changes"
            echo "3. Try pushing again"
            exit 1
        fi
        
        echo "âœ… Version synchronization validated: $TAG_VERSION"
    fi
done

exit 0
